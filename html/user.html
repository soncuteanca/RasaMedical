<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>User Profile - Medical Assistant</title>
    <style>
        body {
            background-color: #CFC3BD;
            font-family: Arial, sans-serif;
            margin: 0;
            color: #2C2C2C;
        }
        header {
            background-color: #5E1F28;
            color: #F0EDEA;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 2;
            box-sizing: border-box;
        }
        .title {
            font-size: 32px;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .button-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .button {
            min-width: 120px;
            border-radius: 12px;
            font-size: 18px;
            padding: 12px 24px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            margin: 0;
            text-align: center;
            font-weight: bold;
            border: 2px solid #5E1F28;
            box-sizing: border-box;
        }
        .button-chat {
            background: #B3A09A;
            color: #5E1F28;
            border: 2px solid #5E1F28;
        }
        .button-chat:hover {
            background: #4A1F24;
            color: #F0EDEA;
        }
        .button-login, .button-create, .button-logout {
            background-color: #4A1F24;
            color: #F0EDEA;
            border: 2px solid #4A1F24;
        }
        .button-login:hover, .button-create:hover, .button-logout:hover {
            background-color: #B3A09A;
            color: #5E1F28;
            border-color: #B3A09A;
        }
        @media (max-width: 768px) {
            header {
                padding: 15px 20px;
            }
            .title {
                font-size: 24px;
            }
            .button {
                min-width: 100px;
                font-size: 16px;
                padding: 10px 20px;
            }
        }
        .container {
            max-width: 900px;
            margin: 120px auto 40px auto;
            background: #B3A09A;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 32px 40px 40px 40px;
            position: relative;
        }
        h2 {
            text-align: center;
            color: #5E1F28;
            font-size: 28px;
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: bold;
            border-bottom: 3px solid #5E1F28;
            padding-bottom: 15px;
        }
        .profile-section {
            border-bottom: 1px solid #B3A09A;
            padding-bottom: 18px;
            margin-bottom: 24px;
        }
        .profile-info {
            display: flex;
            align-items: center;
            gap: 32px;
        }
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            background: #B3A09A;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: #5E1F28;
            font-weight: bold;
            border: 2px solid #5E1F28;
        }
        .profile-details {
            flex: 1;
        }
        .section {
            margin-bottom: 32px;
        }
        .section-title {
            font-size: 22px;
            color: #5E1F28;
            margin-bottom: 12px;
            font-weight: bold;
        }
        .record-list, .appointment-list {
            list-style: none;
            padding: 0;
        }
        .record-list li, .appointment-list li {
            background: #CFC3BD;
            margin-bottom: 10px;
            padding: 14px 18px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            border-left: 4px solid #B3A09A;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .appointment-list li:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .appointment-scheduled {
            border-left-color: #8B4513 !important;
        }
        .appointment-cancelled {
            border-left-color: #5E1F28 !important;
            opacity: 0.8;
        }
        .appointment-completed {
            border-left-color: #A0522D !important;
        }
        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .appointment-date-time {
            font-weight: bold;
            color: #5E1F28;
            font-size: 16px;
        }
        .appointment-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-scheduled {
            background: #D0C8C0;
            color: #8B4513;
            border: 1px solid #8B4513;
        }
        .status-cancelled {
            background: #B3A09A;
            color: #5E1F28;
            border: 1px solid #5E1F28;
        }
        .status-completed {
            background: #CFC3BD;
            color: #A0522D;
            border: 1px solid #A0522D;
        }
        .appointment-details {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
        .appointment-doctor {
            color: #5E1F28;
            font-weight: 600;
        }
        .appointment-reason {
            margin-top: 4px;
            font-style: italic;
        }
        .empty-msg {
            color: #888;
            font-style: italic;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 18px;
            color: #5E1F28;
            text-decoration: none;
            font-weight: bold;
            font-size: 18px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s, color 0.2s;
        }
        .back-link:hover {
            background-color: #5E1F28;
            color: #F0EDEA;
            text-decoration: none;
        }
        .button-delete, .button-consistent {
            background: #B3A09A;
            color: #5E1F28;
            border: 2px solid #5E1F28;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background 0.2s, color 0.2s;
            min-width: 140px;
            text-align: center;
            box-sizing: border-box;
        }
        .button-delete:hover, .button-consistent:hover {
            background: #4A1F24;
            color: #F0EDEA;
        }
        #deleteModal .modal-content, #successModal .modal-content, #deleteAppointmentModal .modal-content, #deleteRecordModal .modal-content {
            background: #B3A09A;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(114, 47, 55, 0.25);
            text-align: center;
            max-width: 400px;
            border-top: 4px solid #5E1F28;
            padding: 30px 40px;
        }
        #deleteModal h3, #successModal h3, #deleteAppointmentModal h3, #deleteRecordModal h3 {
            color: #5E1F28;
            margin-top: 0;
        }
        #deleteModal .modal-icon, #successModal .modal-icon, #deleteAppointmentModal .modal-icon, #deleteRecordModal .modal-icon {
            font-size: 48px;
            color: #5E1F28;
            margin-bottom: 15px;
        }
        #deleteModal .modal-btn, #successModal .modal-btn, #deleteAppointmentModal .modal-btn, #deleteRecordModal .modal-btn {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            background: #5E1F28;
            color: #F0EDEA;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 0 5px;
            transition: background 0.2s;
        }
        #deleteModal .modal-btn:hover, #successModal .modal-btn:hover, #deleteAppointmentModal .modal-btn:hover, #deleteRecordModal .modal-btn:hover {
            background: #4A1F24;
        }
        #deleteModal .modal-btn.danger, #deleteAppointmentModal .modal-btn.danger, #deleteRecordModal .modal-btn.danger {
            background: #fff;
            color: #5E1F28;
            border: 2px solid #5E1F28;
            transition: background 0.2s, color 0.2s, border 0.2s;
        }
        #deleteModal .modal-btn.danger:hover, #deleteAppointmentModal .modal-btn.danger:hover, #deleteRecordModal .modal-btn.danger:hover {
            background: #5E1F28;
            color: #F0EDEA;
            border-color: #5E1F28;
        }
        .delete-account-link {
            display: inline-block;
            color: #a3866a;
            font-size: 15px;
            text-decoration: none;
            background: none;
            border: 1.5px solid #a3866a;
            border-radius: 6px;
            cursor: pointer;
            padding: 8px 18px;
            font-weight: normal;
            transition: color 0.2s, border-color 0.2s, background 0.2s;
        }
        .delete-account-link:hover {
            color: #fff;
            background: #a3866a;
            border-color: #a3866a;
        }
        .delete-section {
            position: absolute;
            right: 40px;
            bottom: 40px;
        }
        .delete-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #2C0A0F;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .delete-btn:hover {
            color: #8B0000;
            transform: scale(1.2);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        #authModal .modal-content {
            background: #B3A09A;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(114, 47, 55, 0.25);
            text-align: center;
            max-width: 400px;
            border-top: 4px solid #5E1F28;
            padding: 30px 40px;
        }
        #authModal h3 {
            color: #5E1F28;
            margin-top: 0;
        }
        #authModal .modal-icon {
            font-size: 48px;
            color: #5E1F28;
            margin-bottom: 15px;
        }
        #authModal .modal-btn {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            background: #5E1F28;
            color: #F0EDEA;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 0 5px;
            transition: background 0.2s;
        }
        #authModal .modal-btn:hover {
            background: #4A1F24;
        }
    </style>
</head>
<body>
<header>
    <h1 class="title">Medical Assistant</h1>
    <div class="button-container">
        <a href="#" class="button button-chat" onclick="handleChatClick(event)">Chat Now!</a>
        <a href="login.html" class="button button-login" id="loginBtn">Login</a>
        <a href="create_user.html" class="button button-create" id="createAccountBtn">Create Account</a>
        <button class="button button-logout" id="logoutBtn" style="display:none;">Logout</button>
    </div>
</header>
<div class="container">
    <a href="home_page.html" class="back-link">&larr; Back to Home</a>
    <div class="profile-section">
        <div class="profile-info">
            <div class="profile-avatar" id="profileAvatar">U</div>
            <div class="profile-details">
                <h2 id="profileName">User Name</h2>
            </div>
        </div>
    </div>
    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div class="section-title">My Appointments</div>
            <button onclick="manageAppointments()" class="button-consistent">💬 Manage Appointments</button>
        </div>
        
        <ul class="appointment-list" id="appointmentList">
            <li class="empty-msg">Loading appointments...</li>
        </ul>
    </div>
    <div class="section">
        <div class="section-title">Medical Records</div>
        <ul class="record-list" id="recordList">
            <li class="empty-msg">Loading medical records...</li>
        </ul>
    </div>
    <div class="section">
        <button id="deleteAccountBtn" class="button button-delete">Delete Account</button>
    </div>
</div>

<!-- Authentication Modal -->
<div id="authModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div class="modal-content">
        <div class="modal-icon">⚠️</div>
        <h3>Authentication Required</h3>
        <p id="authModalMessage" style="font-size:16px; color:#333; margin-bottom:20px;">Please log in to access the chat feature.</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="closeAuthModal()" class="modal-btn">OK</button>
        </div>
    </div>
</div>

<!-- Delete Account Confirmation Modal -->
<div id="deleteModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div class="modal-content">
        <div class="modal-icon">⚠️</div>
        <h3>Warning: Delete Account</h3>
        <p style="font-size:16px; color:#333; margin-bottom:10px; font-weight:bold;">This action is permanent and cannot be undone!</p>
        <p style="font-size:16px; color:#666; margin-bottom:20px;">All your data will be permanently deleted from our system.</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="closeDeleteModal()" class="modal-btn">Cancel</button>
            <button onclick="confirmDeleteAccount()" class="modal-btn danger">Yes, Delete My Account</button>
        </div>
    </div>
</div>

<!-- Success Message Modal -->
<div id="successModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div class="modal-content">
        <div class="modal-icon">✓</div>
        <h3>Account Deleted</h3>
        <p style="font-size:16px; color:#333; margin-bottom:20px;">Your account has been successfully deleted. You will be redirected to the home page.</p>
        <button onclick="redirectToHome()" class="modal-btn">OK</button>
    </div>
</div>

<!-- Delete Appointment Confirmation Modal -->
<div id="deleteAppointmentModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div class="modal-content">
        <div class="modal-icon">🗑️</div>
        <h3>Delete Appointment</h3>
        <p id="deleteAppointmentText" style="font-size:16px; color:#333; margin-bottom:10px; font-weight:bold;"></p>
        <p style="font-size:14px; color:#666; margin-bottom:20px;">This action cannot be undone. The appointment will be permanently removed from the system.</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="closeDeleteAppointmentModal()" class="modal-btn">Cancel</button>
            <button onclick="confirmDeleteAppointment()" class="modal-btn danger">Yes, Delete</button>
        </div>
    </div>
</div>

<!-- Delete Medical Record Confirmation Modal -->
<div id="deleteRecordModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div class="modal-content">
        <div class="modal-icon">🗑️</div>
        <h3>Delete Medical Record</h3>
        <p id="deleteRecordText" style="font-size:16px; color:#333; margin-bottom:10px; font-weight:bold;"></p>
        <p style="font-size:14px; color:#666; margin-bottom:20px;">This action cannot be undone. The medical record will be permanently removed from the system.</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="closeDeleteRecordModal()" class="modal-btn">Cancel</button>
            <button onclick="confirmDeleteRecord()" class="modal-btn danger">Yes, Delete</button>
        </div>
    </div>
</div>

<script>
// Function to handle Chat Now button click with authentication check
function handleChatClick(event) {
    event.preventDefault(); // Prevent default link behavior
    
    const token = localStorage.getItem('userToken');
    const user = localStorage.getItem('user');
    
    if (!token || !user) {
        // User is not logged in, show modal and redirect to login
        showAuthModal('Please log in to access the chat feature.');
        return;
    }
    
    try {
        // Validate that user data is properly formatted
        const userObj = JSON.parse(user);
        if (!userObj || !userObj.id || !userObj.name) {
            throw new Error('Invalid user data');
        }
        // User is authenticated, redirect to chat page
        window.location.href = 'chat_page.html';
    } catch (error) {
        // Invalid user data, clear storage and redirect to login
        localStorage.removeItem('userToken');
        localStorage.removeItem('user');
        showAuthModal('Invalid session. Please log in again.');
    }
}

// Show authentication modal
function showAuthModal(message) {
    document.getElementById('authModalMessage').innerText = message;
    document.getElementById('authModal').style.display = 'flex';
}

// Close modal and redirect to login
function closeAuthModal() {
    document.getElementById('authModal').style.display = 'none';
    window.location.href = 'login.html';
}

// Show Logout if logged in, else show Create Account. Show user name instead of Login if logged in.
window.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('userToken');
    const user = localStorage.getItem('user');
    const createBtn = document.getElementById('createAccountBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginBtn = document.getElementById('loginBtn');
    if (token && user) {
        createBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        loginBtn.style.display = 'none';
    } else {
        createBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        loginBtn.style.display = 'inline-block';
    }
    logoutBtn && logoutBtn.addEventListener('click', function() {
        localStorage.removeItem('userToken');
        localStorage.removeItem('user');
        location.href = 'home_page.html';
    });
});
// Load user info from localStorage
const user = localStorage.getItem('user');
if (!user) {
    window.location.href = 'login.html';
}
const userObj = JSON.parse(user);
document.getElementById('profileName').textContent = userObj.name || 'User';
document.getElementById('profileAvatar').textContent = userObj.name ? userObj.name.charAt(0).toUpperCase() : 'U';

// Function to load appointments
function loadAppointments() {
    const list = document.getElementById('appointmentList');
    list.innerHTML = '<li class="empty-msg">Loading appointments...</li>';
    
    console.log('Loading appointments for user ID:', userObj.id);
    
    // First try to get appointments for the current user
    return fetch(`http://localhost:5000/api/appointments?user_id=${userObj.id}`)
        .then(res => {
            console.log('API response status:', res.status);
            return res.json();
        })
        .then(data => {
            console.log('Received appointment data for user', userObj.id, ':', data);
            
            // If no appointments found for current user, try to get all appointments
            // This is a temporary fix to show existing appointments
            if (!data || data.length === 0) {
                console.log('No appointments found for current user, trying to fetch all appointments...');
                return fetch(`http://localhost:5000/api/appointments`)
                    .then(res => res.json())
                    .then(allData => {
                        console.log('All appointments in database:', allData);
                        // Show a message about user ID mismatch
                        if (allData && allData.length > 0) {
                            const uniqueUserIds = [...new Set(allData.map(apt => apt.user_id))];
                            console.log('Appointments exist for user IDs:', uniqueUserIds);
                            console.log('Current logged-in user ID:', userObj.id);
                            
                            // For demonstration, show all appointments but with a warning
                            displayAppointments(allData, true);
                            return allData; // Return the data to prevent further processing
                        }
                        return [];
                    });
            }
            return data;
        })
        .then(data => {
            if (data && data.length > 0) {
                displayAppointments(data, false);
            } else {
                showEmptyState();
            }
        })
        .catch(error => {
            console.error('Error fetching appointments:', error);
            list.innerHTML = '<li class="empty-msg">Failed to load appointments. Please try refreshing the page.</li>';
        });
}

// Function to display appointments
function displayAppointments(appointments, showWarning = false) {
    const list = document.getElementById('appointmentList');
    list.innerHTML = '';
    
    if (showWarning) {
        const warningLi = document.createElement('li');
        warningLi.style.cssText = `
            background: #D0C8C0; 
            border-left: 4px solid #8B4513; 
            margin-bottom: 15px; 
            padding: 15px;
            border-radius: 8px;
        `;
        warningLi.innerHTML = `
            <div style="color: #5E1F28; font-weight: bold; margin-bottom: 5px;">⚠️ User ID Mismatch Detected</div>
            <div style="color: #8B4513; font-size: 14px;">
                Showing appointments from database. Some appointments may belong to different users.
                <br><strong>Current user ID:</strong> ${userObj.id}
                <br><strong>Tip:</strong> Use the chat to create appointments for your account.
            </div>
        `;
        list.appendChild(warningLi);
    }

    // Sort appointments by date (newest first)
    appointments.sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date));
    
    appointments.forEach(app => {
        const li = document.createElement('li');
        const status = app.status || 'scheduled';
        li.className = `appointment-${status}`;
        
        // Format date and time
        const appointmentDate = new Date(app.appointment_date);
        const dateStr = appointmentDate.toLocaleDateString('en-US', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        const timeStr = appointmentDate.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Determine if appointment is in the past, today, or future
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const appointmentDay = new Date(appointmentDate.getFullYear(), appointmentDate.getMonth(), appointmentDate.getDate());
        
        let dateIcon = '📅';
        if (appointmentDay < today) {
            dateIcon = '📋'; // Past appointment
        } else if (appointmentDay.getTime() === today.getTime()) {
            dateIcon = '🔔'; // Today
        } else {
            dateIcon = '📅'; // Future appointment
        }
        
        // Add user ID info if showing warning
        const userInfo = showWarning ? `<div style="font-size: 12px; color: #666;">User ID: ${app.user_id}</div>` : '';
        
        li.innerHTML = `
            <div class="appointment-header">
                <div class="appointment-date-time">${dateIcon} ${dateStr} at ${timeStr}</div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="appointment-status status-${status}">${status}</div>
                    <button onclick="deleteAppointment(${app.id}, '${dateStr}', '${timeStr}', '${app.doctor_name || 'Doctor'}')" 
                            class="delete-btn" title="Delete Appointment">🗑️</button>
                </div>
            </div>
            <div class="appointment-details">
                <div class="appointment-doctor">👨‍⚕️ ${app.doctor_name || 'Doctor not specified'}</div>
                <div class="appointment-reason">📝 ${app.reason || 'No reason specified'}</div>
                ${userInfo}
            </div>
        `;
        list.appendChild(li);
    });
}

// Function to show empty state
function showEmptyState() {
    const list = document.getElementById('appointmentList');
    list.innerHTML = `
        <li class="empty-msg">
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px; color: #5E1F28;">📋</div>
                <div style="font-size: 18px; margin-bottom: 10px;">No appointments scheduled</div>
                <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                    Book an appointment through our chat assistant!
                </div>
                <button onclick="manageAppointments()" class="button-consistent">
                    💬 Start Booking
                </button>
            </div>
        </li>
    `;
}

// Function to refresh appointments
function refreshAppointments() {
    loadAppointments().then(() => {
        // Show a temporary success message
        const list = document.getElementById('appointmentList');
        const successMsg = document.createElement('div');
        successMsg.textContent = '✅ Appointments refreshed!';
        successMsg.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            background: #8B4513;
            color: #F0EDEA;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            font-weight: bold;
            border: 2px solid #5E1F28;
        `;
        document.body.appendChild(successMsg);
        
        setTimeout(() => {
            document.body.removeChild(successMsg);
        }, 2000);
    });
}

// Function to manage appointments via chat
function manageAppointments() {
    // Store a flag to indicate the user wants to manage appointments
    localStorage.setItem('appointmentAction', 'manage');
    handleChatClick(new Event('click'));
}

// Initial load of appointments
loadAppointments();

// Load medical records function
function loadMedicalRecords() {
    return fetch(`http://localhost:5000/api/records?user_id=${userObj.id}`)
        .then(res => res.json())
        .then(data => {
            displayMedicalRecords(data);
        })
        .catch(error => {
            console.error('Error fetching medical records:', error);
            const list = document.getElementById('recordList');
            list.innerHTML = '<li class="empty-msg">Failed to load medical records. Please try refreshing the page.</li>';
        });
}

// Function to display medical records (matching appointment style EXACTLY)
function displayMedicalRecords(records) {
    const list = document.getElementById('recordList');
    list.innerHTML = '';
    
    if (Array.isArray(records) && records.length > 0) {
        // Sort records by date (newest first)
        records.sort((a, b) => new Date(b.record_date) - new Date(a.record_date));
        
        records.forEach(rec => {
            const li = document.createElement('li');
            // Use same class structure as appointments
            li.className = `appointment-${rec.record_type}`;
            
            // Format date EXACTLY like appointments (with time component)
            const recordDate = new Date(rec.record_date);
            const dateStr = recordDate.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            // Add a mock time for records (since medical records typically don't have specific times)
            // Use creation time or default to a standard time
            const timeStr = rec.created_at ? 
                new Date(rec.created_at).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '12:00 PM';
            
            // Use calendar icon like appointments (📅) instead of record-specific icons
            const dateIcon = '📅';
            
            // Format status exactly like appointments (readable format)
            const status = rec.record_type.replace('_', ' ').toUpperCase();
            
            li.innerHTML = `
                <div class="appointment-header" onclick="toggleRecord(${rec.id})" style="cursor: pointer;">
                    <div class="appointment-date-time">${dateIcon} ${dateStr} at ${timeStr}</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="appointment-status status-${rec.record_type}">${status}</div>
                        <button onclick="event.stopPropagation(); deleteRecord(${rec.id}, '${rec.title}', '${dateStr}')" 
                                class="delete-btn" title="Delete Record">🗑️</button>
                        <div id="expand-icon-${rec.id}" style="font-size: 12px; color: #666;">▼</div>
                    </div>
                </div>
                <div class="appointment-details">
                    <div class="appointment-reason" style="font-weight: bold;">📋 ${rec.title}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 2px;">👨‍⚕️ ${rec.doctor_name || 'Doctor not specified'}</div>
                    <div id="record-details-${rec.id}" style="display: none; margin-top: 10px; padding: 10px; background: #F5F5F5; border-radius: 5px; border-left: 3px solid #8B4513;">
                        ${rec.description ? `<div style="color: #333; font-size: 14px;"><strong>Details:</strong><br/>${rec.description}</div>` : '<div style="color: #666; font-style: italic;">No additional details available.</div>'}
                    </div>
                </div>
            `;
            list.appendChild(li);
        });
    } else {
        showEmptyRecordsState();
    }
}

// Function to show empty state for records
function showEmptyRecordsState() {
    const list = document.getElementById('recordList');
    list.innerHTML = `
        <li class="empty-msg">
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px; color: #5E1F28;">📋</div>
                <div style="font-size: 18px; margin-bottom: 10px;">No medical records found</div>
                <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                    Records will appear here after your appointments and consultations.
                </div>
            </div>
        </li>
    `;
}

// Load medical records on page load
loadMedicalRecords();

// Add delete account functionality
document.getElementById('deleteAccountBtn').addEventListener('click', function(event) {
    event.preventDefault();
    document.getElementById('deleteModal').style.display = 'flex';
});

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

async function confirmDeleteAccount() {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || !user.id) {
        alert('Error: User information not found');
        return;
    }

    try {
        const response = await fetch(`http://localhost:5000/api/users/${user.id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            // Clear local storage
            localStorage.removeItem('userToken');
            localStorage.removeItem('user');
            // Show success message
            document.getElementById('deleteModal').style.display = 'none';
            document.getElementById('successModal').style.display = 'flex';
        } else {
            const result = await response.json();
            alert('Error deleting account: ' + result.error);
        }
    } catch (error) {
        alert('Error deleting account: ' + error.message);
    }
}

function redirectToHome() {
    window.location.href = 'home_page.html';
}

// Global variables for deletion
let appointmentToDelete = null;
let recordToDelete = null;

// Function to initiate appointment deletion
function deleteAppointment(appointmentId, dateStr, timeStr, doctorName) {
    appointmentToDelete = appointmentId;
    document.getElementById('deleteAppointmentText').innerHTML = 
        `Are you sure you want to delete this appointment?<br><br>
        <strong>📅 ${dateStr} at ${timeStr}</strong><br>
        <strong>👨‍⚕️ ${doctorName}</strong>`;
    document.getElementById('deleteAppointmentModal').style.display = 'flex';
}

// Function to initiate medical record deletion
function deleteRecord(recordId, title, dateStr) {
    recordToDelete = recordId;
    document.getElementById('deleteRecordText').innerHTML = 
        `Are you sure you want to delete this medical record?<br><br>
        <strong>📋 ${title}</strong><br>
        <strong>📅 ${dateStr}</strong>`;
    document.getElementById('deleteRecordModal').style.display = 'flex';
}

// Function to close delete appointment modal
function closeDeleteAppointmentModal() {
    document.getElementById('deleteAppointmentModal').style.display = 'none';
    appointmentToDelete = null;
}

// Function to close delete record modal
function closeDeleteRecordModal() {
    document.getElementById('deleteRecordModal').style.display = 'none';
    recordToDelete = null;
}

// Function to confirm appointment deletion
async function confirmDeleteAppointment() {
    if (!appointmentToDelete) {
        alert('Error: No appointment selected for deletion');
        return;
    }

    try {
        const response = await fetch(`http://localhost:5000/api/appointments/${appointmentToDelete}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            // Close modal
            closeDeleteAppointmentModal();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.textContent = '✅ Appointment deleted successfully!';
            successMsg.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: #8B4513;
                color: #F0EDEA;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 1000;
                font-weight: bold;
                border: 2px solid #5E1F28;
            `;
            document.body.appendChild(successMsg);
            
            // Remove success message after 3 seconds
            setTimeout(() => {
                if (document.body.contains(successMsg)) {
                    document.body.removeChild(successMsg);
                }
            }, 3000);
            
            // Reload appointments
            loadAppointments();
        } else {
            const result = await response.json();
            alert('Error deleting appointment: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error deleting appointment: ' + error.message);
    }
}

// Function to confirm medical record deletion
async function confirmDeleteRecord() {
    if (!recordToDelete) {
        alert('Error: No record selected for deletion');
        return;
    }

    try {
        const response = await fetch(`http://localhost:5000/api/records/${recordToDelete}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            // Close modal
            closeDeleteRecordModal();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.textContent = '✅ Medical record deleted successfully!';
            successMsg.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: #8B4513;
                color: #F0EDEA;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 1000;
                font-weight: bold;
                border: 2px solid #5E1F28;
            `;
            document.body.appendChild(successMsg);
            
            // Remove success message after 3 seconds
            setTimeout(() => {
                if (document.body.contains(successMsg)) {
                    document.body.removeChild(successMsg);
                }
            }, 3000);
            
            // Reload medical records
            loadMedicalRecords();
        } else {
            const result = await response.json();
            alert('Error deleting medical record: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error deleting medical record: ' + error.message);
    }
}
</script>
</body>
</html> 